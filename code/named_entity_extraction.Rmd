---
title: "named_entity_extraction"
author: "Fabienne Lind"
date: "2023-02-12"
output: html_document
---


## Read data

Let's load some text data.

```{r cars}

library(data.table)
corpus <- fread("")

```

## Set up spacyr and slect a language model

Visit https://spacy.io/usage/models and select a language model. In this example, we used the model for English.

```{r pressure, echo=FALSE}

library(spacyr)
# spacy_finalize() #close previous session (where previous language model was loaded)
spacy_initialize(model = "en")

```

## Extract Entities

We will now apply the function `spacy_extract_entity`, extracts entities from text (here stored in the dataframe column `text_mt` without first parsing the entire text:


```{r}
corpus_entities <- spacy_extract_entity(corpus$text_mt) # specify the text column

```


## Specify the enty_types wanted 

Let's see what types of entities were extracted.

```{r}
table(corpus_entities$ent_type)
```


In some szenarios we might be interested in specifc entity types only.

For an overview of available entity types see https://spacy.io/usage/linguistic-features#named-entities

# 'PER'  = Named person or family; 
# 'GPO' = Geopolitical entity, i.e. countries, cities, states..
# 'ORG' =  Named corporate, governmental, or other organizational entity.
# 'MISC' =  #Miscellaneous entities, e.g. events, nationalities, products or works of art. 

For this example, we decide to investigate only 'LOC', 'GPE' 'PER'. The following code is an example of how these types are selected from the output generated previously and aggregated back on document level as string column 

```{r}

corpus_entities_sub <- subset(corpus_entities, ent_type == 'PER' | ent_type == 'GPE' | ent_type == 'LOC')

# Aggregate all extracted entities and the corresponding entity_type per article & list them in one string separated by ; 

library(dplyr)
#entity text
entity_agg <- corpus_entities_sub %>% 
  group_by(doc_id) %>% 
  mutate(entity = paste0(text, collapse = "; "))

entity_agg <- subset(entity_agg, select = c(doc_id, entity))

entity_agg$dupl <- duplicated(entity_agg$doc_id) #tag duplicated rows
entity_agg <- subset(entity_agg, dupl == FALSE)# select only unique rows
entity_agg <- subset(entity_agg, select = c(doc_id, entity))


```




